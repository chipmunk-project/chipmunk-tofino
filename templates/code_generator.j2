// This is an autogenerated sketch file corresponding to
// the switch's data path and is used to solve the Chipmunk compilation problem.
// program_file = {{ program_file  }} num_pipeline_stages = {{ num_pipeline_stages }}
// num_alus_per_stage = {{ num_alus_per_stage }}
// num_phv_containers = {{ num_phv_containers }}

{{ hole_definitions }}

// Operand muxes for each ALU in each stage
// Total of {{ num_pipeline_stages }} * {{ num_alus_per_stage }} * 3 {{num_phv_containers}}-to-1 muxes
// The 3 is for two stateless operands and one stateful operand.

{{ operand_mux_definitions }}

// Output mux for each PHV container
// Allows the container to be written from either its own stateless ALU or any stateful ALU

{{ output_mux_definitions }}

// Definition for ALUs

{{ alu_definitions }}

// Data type for holding result from spec and implementation
struct StateAndPacket {
  {% for field_number in range(num_fields_in_prog) %}
    int pkt_{{field_number}};
  {% endfor %}
  {% for state_number in range(num_state_vars) %}
    int state_{{state_number}};
  {% endfor %}
}

// Data type for selection from mux
struct MuxSelection {
  int value;
  int index;
}

// Sketch holes corresponding to stateful configuration indicator variables

// Specification
{{spec_as_sketch}}

|StateAndPacket| pipeline (|StateAndPacket| state_and_packet) implements program {
  // Consolidate all constraints on holes here.
  {{all_assertions}}
  // One variable for each container in the PHV
  // Container i will be allocated to packet field i from the spec.
  {% for container_number in range(num_phv_containers) %}
    int input_0_{{container_number}} = 0;
  {% endfor %} 

  // One variable for each stateful ALU's state operand
  // This will be allocated to a state variable from the program using indicator variables.
  {% for stage_number in range(num_pipeline_stages) %}
   {% for state_var_number in range(num_state_vars) %}
    int state_operand_salu_{{stage_number}}_{{state_var_number}};
   {% endfor %}
  {% endfor %}

  {% for stage_number in range(num_pipeline_stages) %}
  /*********** Stage {{stage_number}} *********/

  // Inputs
  {% if stage_number == 0 %}
  // Read each PHV container from corresponding packet field.
  {% for field_number in range(num_fields_in_prog) %}
  input_0_{{field_number}} = state_and_packet.pkt_{{field_number}};
  {% endfor %}

  {% else %}
  // Input of this stage is the output of the previous one.
  {% for container_number in range(num_phv_containers) %}
  int input_{{stage_number}}_{{container_number}} = output_{{stage_number-1}}_{{container_number}};
  {% endfor %}

  {% endif %}

  // Stateless operands
  {% for alu_number in range(num_alus_per_stage) %}
  |MuxSelection| operand_{{stage_number}}_{{alu_number}}_a = stateless_operand_mux_a_{{stage_number}}_{{alu_number}}(
  {% for container_number in range(num_phv_containers) %}
  {% if container_number != num_phv_containers - 1 %}
  input_{{stage_number}}_{{container_number}},
  {% else %}
  input_{{stage_number}}_{{container_number}}
  {% endif %}
  {% endfor %}
  );
  {% endfor %}

  {% for alu_number in range(num_alus_per_stage) %}
  |MuxSelection| operand_{{stage_number}}_{{alu_number}}_b = stateless_operand_mux_b_{{stage_number}}_{{alu_number}}(
  {% for container_number in range(num_phv_containers) %}
  {% if container_number != num_phv_containers - 1 %}
  input_{{stage_number}}_{{container_number}},
  {% else %}
  input_{{stage_number}}_{{container_number}}
  {% endif %}
  {% endfor %}
  );
  {% endfor %}

  // Stateless ALUs
  {% for alu_number in range(num_alus_per_stage) %}
  int destination_{{stage_number}}_{{alu_number}} = stateless_alu_{{stage_number}}_{{alu_number}}(operand_{{stage_number}}_{{alu_number}}_a, operand_{{stage_number}}_{{alu_number}}_b);
  {% endfor %}

  // Stateful operands
  {% for state_number in range(num_state_vars) %}
  |MuxSelection| packet_operand_salu{{stage_number}}_{{state_number}} = stateful_operand_mux_{{stage_number}}_{{state_number}}(
  {% for container_number in range(num_phv_containers) %}
  {% if container_number != num_phv_containers - 1 %}
  input_{{stage_number}}_{{container_number}},
  {% else %}
  input_{{stage_number}}_{{container_number}}
  {% endif %}
  {% endfor %}
  );
  {% endfor %}

  // Read stateful ALU slots from allocated state vars.
  {% for state_number in range(num_state_vars) %}
  {% if state_number == 0 %}
  if (salu_config_{{stage_number}}_{{state_number}} == 1) { state_operand_salu_{{stage_number}}_{{state_number}} = state_and_packet.state_{{state_number}};}
  {% else %}
  else if (salu_config_{{stage_number}}_{{state_number}} == 1) { state_operand_salu_{{stage_number}}_{{state_number}} = state_and_packet.state_{{state_number}};}
  {% endif %}
  {% endfor %}

  // Stateful ALUs
  {% for state_number in range(num_state_vars) %}
  int old_state_{{stage_number}}_{{state_number}} = stateful_alu_{{stage_number}}_{{state_number}}(state_operand_salu_{{stage_number}}_{{state_number}}, packet_operand_salu{{stage_number}}_{{state_number}});
  {% endfor %}

  // Outputs
  {% for container_number in range(num_phv_containers) %}
  int output_{{stage_number}}_{{container_number}} = output_mux_phv_{{stage_number}}_{{container_number}}(
  {% for state_number in range(num_state_vars) %}
  old_state_{{stage_number}}_{{state_number}},
  {% endfor %}
  destination_{{stage_number}}_{{container_number}}).value;
  {% endfor %}

  {% for state_number in range(num_state_vars) %}
  // Write state_{{state_number}}
  {% if state_number == 0 %}
  if (salu_config_{{stage_number}}_{{state_number}} == 1) { state_and_packet.state_{{state_number}} = state_operand_salu_{{stage_number}}_{{state_number}};}
  {% else %}
  else if (salu_config_{{stage_number}}_{{state_number}} == 1) { state_and_packet.state_{{state_number}} = state_operand_salu_{{stage_number}}_{{state_number}};}
  {% endif %}
  {% endfor %}

  {% endfor %}

  {% for field_number in range(num_fields_in_prog) %}
  // Write pkt_{{field_number}}
  state_and_packet.pkt_{{field_number}} = output_{{num_pipeline_stages - 1}}_{{field_number}};
  {% endfor %}

  // Return updated packet fields and state vars
  return state_and_packet;
}
